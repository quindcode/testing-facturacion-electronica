name:  Cursor Agent - PR Reviewer (Powered by Gemini)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  screenplay-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name:  Obtener el Diff del PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

      - name:  Revisar PR con Gemini y Comentar
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 -c '
          import os, json, urllib.request, subprocess, glob
          
          api_key = os.environ.get("GEMINI_API_KEY")
          pr_number = os.environ.get("PR_NUMBER")
          
          # Leer reglas de Cursor directamente en Python
          cursor_rules = ""
          mdc_files = glob.glob(".cursor/rules/*.mdc")
          for filepath in mdc_files:
              with open(filepath, "r", encoding="utf-8") as rf:
                  cursor_rules += f"\n--- REGLA: {filepath} ---\n{rf.read()}\n"
          
          # Leer el diff
          with open("pr_diff.txt", "r", encoding="utf-8") as f:
              pr_diff = f.read()
          
          if not pr_diff.strip():
              print("No hay cambios en el c贸digo para revisar.")
              exit(0)
          
          # Extraer los archivos completos para contexto real
          result = subprocess.run(["gh", "pr", "view", pr_number, "--json", "files", "--jq", ".files[].path"], capture_output=True, text=True)
          changed_files = [f for f in result.stdout.splitlines() if f.endswith(".java") or f.endswith(".md") or f.endswith(".feature")]
          
          archivos_completos = ""
          for f_path in changed_files:
              if os.path.exists(f_path):
                  with open(f_path, "r", encoding="utf-8") as file:
                      archivos_completos += f"\n\n==== RUTA DEL ARCHIVO: {f_path} ====\n```java\n{file.read()}\n```\n"
          
          # Prompt Din谩mico con FORMATO ESTRICTO (Corregido)
          prompt = f"""
          Eres un Arquitecto de Pruebas Automatizadas (Serenity BDD/Screenplay) implacable y meticuloso. Tu misi贸n es auditar el c贸digo de este Pull Request.
          
          PARTE A: REGLAS ESPECFICAS DE CARPETA (.mdc)
          <cursor_rules>
          {cursor_rules}
          </cursor_rules>
          
          PARTE B: MEJORES PRCTICAS GENERALES
          1. Logs en Producci贸n: Prohibido `System.out.println` o `e.printStackTrace()`. Exige SLF4J/Logback.
          2. Bloques Catch vac铆os o malos manejos de excepciones.
          3. Violaciones evidentes de Clean Code y principios SOLID.
          
          ARCHIVOS A AUDITAR (CDIGO COMPLETO):
          <archivos>
          {archivos_completos}
          </archivos>
          
          EL DIFF (Cambios que el dev hizo hoy):
          <diff>
          {pr_diff}
          </diff>
          
          INSTRUCCIONES DE RESPUESTA Y FORMATO DE SALIDA:
          Tu respuesta ser谩 publicada directamente en GitHub. DEBE verse impecable, profesional y altamente t茅cnica. No incluyas saludos, despedidas, ni texto fuera de la plantilla.
          
          Si encuentras violaciones, USA ESTRICTAMENTE esta plantilla Markdown:
          
          ##  Resumen de la Auditor铆a
          [Un p谩rrafo t茅cnico y ejecutivo resumiendo el estado general del PR y el impacto de los errores encontrados]
          
          ##  Hallazgos Detallados
          
          [Para cada archivo con errores, repite esta estructura exacta:]
          ###  `[Ruta exacta del archivo]`
          - **Gravedad:** [ Cr铆tica |  Advertencia |  Sugerencia Menor]
          - **Regla Violada:** [Menciona el archivo .mdc exacto, ej. `screenplay-kafka-tasks.mdc`, o el principio general]
          - **Diagn贸stico T茅cnico:** [Explicaci贸n concisa y t茅cnica del porqu茅 est谩 mal]
          - **Refactorizaci贸n Propuesta:**
            ```java
            // Escribe aqu铆 el c贸digo corregido, listo para copiar y pegar, aplicando Screenplay y Lombok correctamente.
            ```
          ---
          
          Si el c贸digo de los archivos modificados es absolutamente perfecto, responde NICAMENTE con la palabra "LGTM" sin ning煤n otro caracter.
          """
          
          # Llamada a Gemini
          payload = {
              "systemInstruction": {
                  "parts": [{"text": "Eres un auditor de c贸digo senior, cr铆tico y detallista. Tu comunicaci贸n es formal, directa y estructurada."}]
              },
              "contents": [{"parts": [{"text": prompt}]}],
              "generationConfig": {"temperature": 0.1}
          }
          
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={api_key}"
          req = urllib.request.Request(url, data=json.dumps(payload).encode("utf-8"), headers={"Content-Type": "application/json"})
          
          try:
              with urllib.request.urlopen(req) as response:
                  res_data = json.loads(response.read())
                  ai_comment = res_data["candidates"][0]["content"]["parts"][0]["text"].strip()
          
                  if ai_comment != "LGTM":
                      with open("comment.md", "w", encoding="utf-8") as f:
                          f.write("###  Auditor铆a de C贸digo y Arquitectura (Gemini AI)\n\n" + ai_comment)
          
                      print("隆Se detectaron malas pr谩cticas! Publicando comentario formateado en GitHub...")
                      subprocess.run(["gh", "pr", "comment", pr_number, "-F", "comment.md"])
                  else:
                      print("El c贸digo es perfecto. LGTM.")
          
          except Exception as e:
              print(f"Error cr铆tico en la API: {e}")
              exit(1)
          '