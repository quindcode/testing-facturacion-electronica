name:  Cursor Agent - PR Reviewer (Powered by Gemini)

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  screenplay-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout del c贸digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name:  Extraer Reglas de Cursor (.mdc)
        id: extract_rules
        run: |
          RULES_CONTEXT=$(cat .cursor/rules/*.mdc 2>/dev/null || echo "No se encontraron reglas espec铆ficas.")
          echo "CURSOR_RULES<<EOF" >> $GITHUB_ENV
          echo "$RULES_CONTEXT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name:  Obtener el Diff del PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Obtenemos los cambios exactos de este PR para que la IA los lea
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

      - name:  Revisar PR con Gemini y Comentar
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 -c '
          import os, json, urllib.request, subprocess
          
          api_key = os.environ.get("GEMINI_API_KEY")
          pr_number = os.environ.get("PR_NUMBER")
          cursor_rules = os.environ.get("CURSOR_RULES", "")
          
          # Leer el diff del PR
          with open("pr_diff.txt", "r") as f:
              pr_diff = f.read()
          
          if not pr_diff.strip():
              print("No hay cambios en el c贸digo para revisar.")
              exit(0)
          
          # Prompt din谩mico enriquecido con tu gradle
          prompt = f"""
          Revisa el siguiente git diff de un Pull Request. 
          Contexto del proyecto: Java 21, Serenity BDD 4.0.12, Patr贸n Screenplay para APIs, Lombok y JavaFaker.
          
          REGLAS DE ARQUITECTURA (Cursor):
          {cursor_rules}
          
          REGLAS CRTICAS DE EQUIPO:
          1. TASKS: Cero aserciones l贸gicas.
          2. MODELS: Prohibido JSON quemado en Strings. Usar POJOs/DTOs aprovechando @Data o @Builder de Lombok.
          3. AUTH: Prohibido variables static. Compartir estado usando actor.remember() y actor.recall().
          4. TEST DATA: Generar datos din谩micos obligatoriamente usando JavaFaker (Faker).
          5. QUESTIONS: Dedicadas estrictamente a leer SerenityRest.lastResponse().
          
          DIFF A REVISAR:
          ```diff
          {pr_diff}
          ```
          
          INSTRUCCIONES: 
          Si detectas violaciones a estas reglas, escribe un comentario constructivo en formato Markdown mencionando el archivo y la sugerencia de c贸digo. 
          Si todo est谩 correcto, responde NICAMENTE con la palabra "LGTM".
          """
          
          # Estructura de la petici贸n a la API de Gemini
          payload = {
              "systemInstruction": {
                  "parts": [{"text": "Eres un Arquitecto de Pruebas Automatizadas y L铆der T茅cnico muy estricto pero emp谩tico."}]
              },
              "contents": [{"parts": [{"text": prompt}]}],
              "generationConfig": {"temperature": 0.2} # Temperatura baja para que sea anal铆tico y no creativo
          }
          
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key={api_key}"
          req = urllib.request.Request(url, data=json.dumps(payload).encode("utf-8"), headers={"Content-Type": "application/json"})
          
          try:
              # Llamada a la API
              with urllib.request.urlopen(req) as response:
                  res_data = json.loads(response.read())
                  ai_comment = res_data["candidates"][0]["content"]["parts"][0]["text"].strip()
          
                  # Publicar en GitHub solo si hay observaciones
                  if ai_comment != "LGTM":
                      with open("comment.md", "w") as f:
                          f.write("###  Revisi贸n Arquitect贸nica (Gemini AI)\n\n" + ai_comment)
          
                      print("Publicando comentarios en el PR...")
                      subprocess.run(["gh", "pr", "comment", pr_number, "-F", "comment.md"])
                  else:
                      print("El c贸digo cumple con todas las reglas. No se requieren comentarios.")
          
          except Exception as e:
              print(f"Error al comunicarse con Gemini o GitHub: {e}")
              exit(1)
          '