name: ü§ñ Cursor Agent - PR Reviewer (Powered by Gemini)

on:
  pull_request:
    types: [opened, synchronize]
    # Se elimin√≥ la restricci√≥n de 'paths' para asegurar que se ejecute en tu prueba actual
    # Puedes volver a activarla despu√©s de validar que el pipeline funciona.

jobs:
  screenplay-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write 

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üß† Extraer Reglas de Cursor (.mdc)
        id: extract_rules
        run: |
          # Consolidamos tus reglas de la carpeta .cursor/rules para pas√°rselas a Gemini
          RULES_CONTEXT=$(cat .cursor/rules/*.mdc 2>/dev/null || echo "No se encontraron reglas espec√≠ficas.")
          echo "CURSOR_RULES<<EOF" >> $GITHUB_ENV
          echo "$RULES_CONTEXT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Ejecutar Revisi√≥n con Gemini
        uses: sshnaidm/gemini-code-review-github-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          model: 'gemini-1.5-flash' # Modelo r√°pido y optimizado para AI Studio
          prompt: |
            Eres un Arquitecto de Pruebas Automatizadas y L√≠der T√©cnico. 
            Tu objetivo es revisar este Pull Request de Serenity BDD con Screenplay para APIs.
            
            DEBES basar tu revisi√≥n en estas reglas de arquitectura configuradas en el proyecto:
            
            ${{ env.CURSOR_RULES }}
            
            REGLAS CR√çTICAS ADICIONALES:
            1. TASKS: Sin aserciones (.then().statusCode(), Ensure, seeThat).
            2. MODELS: Prohibido JSON en Strings. Usar POJOs/DTOs.
            3. AUTH: Prohibido variables 'static'. Usar actor.remember() y actor.recall().
            4. TEST DATA: Usar Factories con Datafaker para datos √∫nicos.
            5. QUESTIONS: Solo leer SerenityRest.lastResponse().
            
            Si detectas una violaci√≥n, comenta en la l√≠nea de c√≥digo indicando la falla y sugiriendo la correcci√≥n. 
            Si todo est√° bien, no comentes nada.